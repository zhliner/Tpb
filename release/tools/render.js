import{Filter as t}from"./filter.js";import{Spliter as e,UmpCaller as n,UmpString as r}from"./spliter.js";import{Util as l}from"./util.js";
//! $ID: render.js 2019.09.17 Tpb.Tools $
const s=window.$,o=new WeakMap,i=Symbol("scope-data"),a=Symbol("each-index"),u=Symbol("compare-result"),c=Symbol("switch-value"),f=Symbol("case-pase"),h=Symbol("switch-display"),p=new e("|",new n,new r),g={Method:[["tpb-each","$each"],["tpb-with","$with"],["tpb-var","$var"],["tpb-else","$else"],["tpb-if","$if"],["tpb-case","$case"],["tpb-last","$last"],["tpb-switch","$switch"],["tpb-for","$for"]],grammar(t){let e=new Map;for(const[n,r]of this.Method)t.hasAttribute(n)&&(this[r](e,t.getAttribute(n),t),t.removeAttribute(n));return this.assign(e,t)},$each:(t,e,n)=>(function(t){let e=o.get(t),n=e&&e.get("For");n&&(n[2]=!0)}(n.parentElement),t.set("Each",[$.loop(e),1])),$for:(t,e,n)=>t.set("For",[$.loop(e),n.childElementCount,!1]),$with:(t,e)=>t.set("With",[$.value(e)]),$var:(t,e)=>t.set("Var",[$.value(e)]),$if:(t,e)=>t.set("If",[$.value(e)]),$else:(t,e)=>t.set("Else",[e?$.value(e):$.pass()]),$switch:(t,e)=>t.set("Switch",[$.value(e)]),$case:(t,e)=>t.set("Case",[$.value(e)]),$last:(t,e)=>t.set("Last",[e?$.value(e):null]),assign(t,e){let n=[],r=[];for(let t of Array.from(e.attributes)){let l=t.name;"_"==l[0]&&(n.push(l.substring(1)),r.push($.assign(t.value)),e.removeAttribute(l))}return n.length>0?t.set("Assign",[n,r]):t}},m={Each(t,e,n,r){let l=t[a]||0,s=e(r);this._alignEach(function(t,e){let n=[];for(;--e>=0&&t;)n.push(t),t=t.nextElementSibling;return n}(t,n-l),s.length,l+1).forEach(((t,e)=>t[i]=v(s[e],e,r))),o.get(t).get("Each")[1]=s.length+l},For(t,e,n,r,l){if(y(t))return;let o=e(l);this._alignFor(function(t,e){if(e)for(const e of s.children(t,"[_]"))e[a]>0&&s.remove(e);return s.children(t)}(t,r),n,o.length).forEach(((t,e)=>{let r=parseInt(e/n);t[i]=v(o[r],r,l)}))},With(t,e,n){let r=e(n);r||(r=Object(r)),r.$=n,"Object"==s.type(r)&&"Object"==s.type(n)&&s.proto(r,n),t[i]=r},Var(t,e,n){e(n)},If:(t,e,n)=>e(n)?_(t):A(t),Else(t,e,n){return function(t){let e;for(const n of s.prevAll(t,"[_]")){if(e=o.get(n),e.has("If"))return!n[u];if(e.has("Else")&&n[u])return!1}throw new Error("Else not find previous If.")}(t)?this.If(t,e,n):A(t)},Switch(t,e,n){y(t)||(t[c]=e(n),t.style.display=function(t){void 0===t[h]&&(t[h]=t.style.display);return t[h]}(t))},Case(t,e,n){let r=t.parentElement;S(r)&&r[c]===e(n)?(_(t),r[f]=!0):(A(t),r[f]=!1)},Last(t,e,n){let r=t.parentElement;if(!e)return S(r)?_(t):A(t);this.Case(t,e,n),S(r)&&(r.style.display="none")},Assign(t,e,n,r){y(t)||e.forEach(((e,l)=>s.attr(t,e||"text",n[l](r))))},_alignEach(t,e,n){let r=e-t.length;if(r<0)t.splice(r).forEach((t=>s.remove(t)));else if(r>0){let e=t[t.length-1];t.push(...s.after(e,function(t,e,n){let r=[];for(let l=0;l<e;l++){let e=s.clone(t,!0,!0,!0);e[a]=n+l,r.push(d(t,e))}return r}(e,r,n)))}return t},_alignFor(t,e,n){let r=n-parseInt(t.length/e);if(r<0)t.splice(r*e).forEach((t=>s.remove(t)));else if(t.length>0&&r>0){let n=function(t,e){let n=[];for(let r=0;r<e;r++)n=n.concat(w(t));return n}(t.slice(-e),r);t.push(...s.after(t[t.length-1],n))}return t}},$={value:t=>new Function("$",`return ${t};`),loop:t=>t?new Function("$",`return ${t};`):t=>t,pass:()=>()=>!0,assign(t){let e=[...p.split(t)],n=new Function("$",`return ${e.shift()};`);if(0==e.length)return n;let r=e.map(b);return t=>r.reduce(((e,n)=>n[0](e,...n[1](t))),n(t))}};function b(e){let n=l.funcArgs(e.trim());return[t[n.name],new Function("$",`return [${n.args}]`)]}function E(t,e){let n=[t];return"TEMPLATE"===t.nodeName&&(t=t.content),n.concat(s.find(e,t))}function d(t,e){var n,r;return n=E(t,"[_]"),r=E(e,"[_]"),n.forEach(((t,e)=>o.set(r[e],o.get(t)))),e}function w(t){let e=t.map((t=>s.clone(t,!0,!0,!0)));return e.forEach(((e,n)=>d(t[n],e))),e}function v(t,e,n){return null==t?t:Object.assign(t,{INDEX:e,SIZE:n.length,$:n})}function y(t){return!1===t[u]}function A(t){let e=s.attr(s.elem("template"),"_","");s.append(s.replace(t,e).content,t),e[u]=!1,o.set(e,o.get(t))}function _(t){y(t)&&s.replace(t,t.content.firstElementChild),t[u]=!0}function S(t){return!t[f]}const F={parse:function(t){let e;for(const n of s.find("*",t,!0))e=g.grammar(n),e.size>0&&(o.set(n,e),n.setAttribute("_",""));return t},clone:d,update:function t(e,n){n=function(t,e){let n=o.get(t);if(n)for(const[r,l]of n)m[r](t,...l,t[i]||e);return t[i]||e}(e,n);for(let r=0;r<e.children.length;r++)t(e.children[r],n);return e},get:function(t){return o.get(t)}};export{F as Render};
